<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
--><html><head><link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">






<link rel="import" href="shared-styles.html">

</head><body><dom-module id="my-view1">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        padding: 10px;
      }

      paper-checkbox {
        display: block;
        margin-top: 5px;
      }

      pre {
        color: black;
        font-size: 20px;
        font-family: 'Roboto', 'Times New Roman', Times, serif;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        text-align: justify;
      }

      p {
        word-wrap: break-word;
        color: black;
      }

      pre p {
        margin: 0;
      }

      .pagination {
        margin-top: 20px;
      }

      .wrong {
        background-color: red;
      }

      .right {
        background-color: green;
      }

      .ind {
        background-color: gray;
      }
    </style>

    <iron-ajax auto="" url="question.json" handle-as="json" on-response="handleResponse"></iron-ajax>

    <div class="card" hidden$="[[isSubmited]]">
      <div class="circle">[[currentQuestion.id]]</div>
      <h3>Question</h3>
      <pre>          <p>[[currentQuestion.question]]</p>
      </pre>

      <div class="answer">

        <template is="dom-if" if="[[currentQuestion.isRadioButton]]">
          <paper-radio-group selected="{{currentQuestion.answers}}">
            <paper-radio-button name="true">True</paper-radio-button>
            <paper-radio-button name="false">False</paper-radio-button>
          </paper-radio-group>
        </template>

        <template is="dom-if" if="[[!currentQuestion.isRadioButton]]">
          <template is="dom-repeat" items="[[currentQuestion.answers]]">
            <div style="text-align: justify; padding: 10px 10px 10px 0;">
              <paper-checkbox name="[[item.answer]]" checked="{{item.checked}}">[[item.answer]]</paper-checkbox>
            </div>
          </template>
        </template>


      </div>
      <div class="pagination">

        <paper-icon-button icon="icons:arrow-back" disabled$="[[canBack]]" on-click="back"></paper-icon-button>
        <paper-icon-button icon="icons:arrow-forward" disabled$="[[canNext]]" on-click="next"></paper-icon-button>
        <span>[[_addOneValue(currentQuestionIndex)]] of [[totalQuestions]]</span>
        <br>
        <paper-button raised="" on-click="submit">Submit</paper-button>

      </div>
    </div>

    <div hidden$="[[!isSubmited]]">
      <template is="dom-repeat" items="{{questionsSubmited}}">
        <div class="card">

          <div class$="[[item.ball]]">[[item.id]]</div>
          <h3>Question</h3>
          <pre>          <p>[[item.question]]</p>
        </pre>

          <div class="answer">

            <template is="dom-if" if="[[item.isRadioButton]]">
              <paper-radio-group selected="{{item.answers}}">
                <paper-radio-button name="true" disabled="">True</paper-radio-button>
                <paper-radio-button name="false" disabled="">False</paper-radio-button>
              </paper-radio-group>
            </template>

            <template is="dom-if" if="[[!item.isRadioButton]]">

              <template is="dom-repeat" items="[[item.answers]]" as="a">
                <div style="text-align: justify; padding: 10px 10px 10px 0;">
                  <paper-checkbox name="[[a.answer]]" checked$="[[a.checked]]" disabled="true">[[a.answer]]</paper-checkbox>
                </div>
              </template>
            </template>
            <p>
              Answer: [[item.answer]]
            </p>

            <template is="dom-if" if="[[item.moreInformationLink]]">
              <paper-dialog id="scrolling-[[item.id]]">
                <h2>Scrolling</h2>
                <paper-dialog-scrollable>
                  <iframe src="[[item.moreInformationLink]]"></iframe>
                </paper-dialog-scrollable>
                <div class="buttons">
                  <paper-button dialog-dismiss="">Ok</paper-button>
                </div>
              </paper-dialog>
              <paper-button raised="" onclick="document.querySelector('scrolling-[[item.id]]').open()">More Information</paper-button>
            </template>

          </div>
        </div>
      </template>
    </div>

  </template>

  <script>
    (function () {
      "use strict";

      const WRONG = 'wrong',
        RIGHT = 'right',
        NUMBER_OF_QUESTIONS = parseInt(prompt('Please, insert the number(10 - 110) of questions?', '40')) || 40;
      Polymer({
        is: 'my-view1',

        properties: {
          questions: {
            type: Array,
            notify: true
          },
          questionsSubmited: {
            type: Array,
            notify: true
          },
          currentQuestion: Object,
          currentQuestionIndex: Number,
          totalQuestions: Number,
          canNext: Boolean,
          canBack: Boolean,
          isSubmited: Boolean
        },
        arrows: function (e) {
          switch (e.which) {
            case 37: // left
              this.back();
              break;
            case 39: // right
              this.next();
              break;
            default:
              return; // exit this handler for other keys
          }
        },

        handleResponse: function (e) {
          this.isSubmited = false;
          document.body.addEventListener('keyup', this.arrows.bind(this));
          this.currentQuestionIndex = 0;
          this.questions = e.detail.response;

          //this._downloadJson(this.questions);
          this.questions = this.shuffle(this.questions);
          this.questions = this.questions.slice(0, NUMBER_OF_QUESTIONS);
          this.canBack = true;
          this.totalQuestions = this.questions.length;
          this.currentQuestion = this.questions[0];
          this.canNext = this.questions.length < 1;
        },

        next: function () {
          if ((this.currentQuestionIndex + 1) !== this.questions.length) {
            this.currentQuestionIndex++;
            this.currentQuestion = this.questions[this.currentQuestionIndex];
            this.canNext = (this.currentQuestionIndex + 1) === this.questions.length;
            this.canBack = this.currentQuestionIndex < 1;
          }
        },

        back: function () {
          if (this.currentQuestionIndex > 0) {
            this.currentQuestionIndex--;
            this.currentQuestion = this.questions[this.currentQuestionIndex];
            this.canBack = this.currentQuestionIndex < 1;
            this.canNext = (this.currentQuestionIndex + 1) === this.questions.length;
          }
        },

        submit: function () {
          let questionsAux = this.questions.slice(0);
          const _this = this;
          questionsAux = questionsAux.map(obj => {
            obj.ball = 'circle ' + _this._isRightQuestion.bind(_this)(obj);
            return obj;
          });
          this.questionsSubmited = questionsAux;
          this.isSubmited = true;
        },

        shuffle: function (array) {
          var currentIndex = array.length,
            temporaryValue, randomIndex;

          // While there remain elements to shuffle...
          while (0 !== currentIndex) {

            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }

          return array;
        },

        _isRightQuestion: function (question) {
          let q = question;
          if (!q.answer && !q.answers) return WRONG;
          if (q.isRadioButton) {
            const isRight = (question.answer.startsWith('False') && q.answer.toLowerCase() === 'false') ||
              (question.answer.startsWith('True') && q.answer.toLowerCase() === 'true');
            return isRight ? RIGHT : WRONG;
          } else {
            let spplitedCorrectAnswer = this._splitAnswers(question.answer),
              userAnwers = q.answers.filter(a => a.checked).map(a => a.answer);

            if (spplitedCorrectAnswer.length !== userAnwers.length) return WRONG;

            for (let i = 0; i < spplitedCorrectAnswer.length; i++)
              if (userAnwers.indexOf(spplitedCorrectAnswer[i]) === -1)
                return WRONG;

            return RIGHT;
          }
        },

        _addOneValue: function (value) {
          return value + 1;
        },

        _splitAnswers: function (q) {
          const answers = [];
          const qf = q.split('F. '),
            qe = qf[0].split('E. '),
            qd = qe[0].split('D. '),
            qc = qd[0].split('C. '),
            qb = qc[0].split('B. '),
            qa = qb[0].split('A. ');
          qf.length > 1 && answers.push('F. ' + qf[1]);
          qe.length > 1 && answers.push('E. ' + qe[1]);
          qd.length > 1 && answers.push('D. ' + qd[1]);
          qc.length > 1 && answers.push('C. ' + qc[1]);
          qb.length > 1 && answers.push('B. ' + qb[1]);
          qa.length > 1 && answers.push('A. ' + qa[1]);
          answers.reverse();
          return answers;
        },

        _downloadJson: function (jsonObj) {
          var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonObj));
          var dlAnchorElem = document.createElement('a');
          dlAnchorElem.setAttribute("href", dataStr);
          dlAnchorElem.setAttribute("download", "question.json");
          dlAnchorElem.click();
        }

      });
    })();
  </script>
</dom-module></body></html>